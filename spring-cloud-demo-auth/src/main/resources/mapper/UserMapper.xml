<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.demo.auth.mapper.UserMapper">

    <resultMap type="com.demo.commons.domain.system.User" id="ROLE_PERMISSION_MAP">
        <id column="userId" property="userId"/>
        <result property="userPhone" column="userPhone" />
        <result property="userPassword" column="userPassword" />
        <result property="salt" column="salt" />
        <result property="userName" column="userName" />
        <collection property="roles" ofType="com.demo.commons.domain.system.Role">
            <id column="roleId" property="roleId"/>
            <result column="roleName" property="roleName"/>
            <result column="roleLevel" property="roleLevel"/>
        </collection>
        <collection property="permissions" ofType="com.demo.commons.domain.system.Permission">
            <id column="permissionId" property="permissionId"/>
            <result column="keyword" property="keyword"/>
            <result column="permissionName" property="permissionName"/>
            <result column="permissionUrl" property="permissionUrl"/>
        </collection>
    </resultMap>
    <select id="login" resultMap="ROLE_PERMISSION_MAP" parameterType= "String">
    select distinct userId,userPhone,userName,userPassword,salt,role.roleId,roleName,roleLevel,permission.permissionId,permissionName,keyword,permissionUrl
    from user,permission,role,user_role,role_permission
    where permission.permissionId in(
    select permissionId from role_permission where roleId in(
    select roleIdOne from user_role where userIdTwo =(
    select userId from user where userPhone = #{userPhone})))and userId =(
    select userId from user where userPhone = #{userPhone}) and userIdTwo = userId and role.roleId = user_role.roleIdOne;
    </select>

</mapper>